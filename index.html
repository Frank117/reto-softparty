<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
    <title>Parqueadero PArk Sistem</title>
    <meta name="theme-color" content="#3b82f6">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="stylesheet" href="assets/css/styles.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <meta name="color-scheme" content="light dark">
</head>
<body>
    <header class="app-header" role="banner">
        <div class="container header-inner">
            <h1>sispark</h1>
            <nav aria-label="Acciones principales" class="top-actions">
                <button id="btnNuevaEntrada" class="btn primary" type="button">Nueva entrada</button>
                <button id="btnDescargarListado" class="btn" type="button">Descargar listado</button>
            </nav>
        </div>
    </header>

    <main class="container" role="main">
        <section class="card" aria-labelledby="titulo-formulario">
            <h2 id="titulo-formulario">Registro de entrada</h2>
            <form id="formRegistro" novalidate>
                <fieldset>
                    <legend>Datos del dueño</legend>
                    <div class="grid">
                        <div class="field">
                            <label for="nombre">Nombre completo</label>
                            <input id="nombre" name="nombre" type="text" required autocomplete="name" placeholder="Ej: Ana Pérez">
                            <p class="hint">Requerido</p>
                        </div>
                        <div class="field">
                            <label for="documento">Documento de identidad</label>
                            <input id="documento" name="documento" type="text" required inputmode="numeric" placeholder="Ej: 1234567890" pattern="[0-9]{5,15}">
                            <p class="hint">Solo números, 5 a 15 dígitos</p>
                        </div>
                        <div class="field">
                            <label for="contacto">Número de contacto</label>
                            <input id="contacto" name="contacto" type="tel" required autocomplete="tel" placeholder="Ej: 3001234567" pattern="[0-9]{7,15}">
                            <p class="hint">Solo números, 7 a 15 dígitos</p>
                        </div>
                    </div>
                </fieldset>

                <fieldset>
                    <legend>Información del vehículo</legend>
                    <div class="grid">
                        <div class="field">
                            <label for="placa">Placa</label>
                            <input id="placa" name="placa" type="text" required placeholder="Ej: ABC123" pattern="^[A-Za-z]{3}[- ]?[0-9A-Za-z]{2,3}$" title="Formato típico: ABC123 o ABC-12D">
                            <p class="hint">Ej: ABC123 o ABC-12D</p>
                        </div>
                        <div class="field">
                            <label for="tipo">Tipo de vehículo</label>
                            <select id="tipo" name="tipo" required>
                                <option value="" disabled selected>Seleccione...</option>
                                <option value="Carro">Carro</option>
                                <option value="Moto">Moto</option>
                                <option value="Bicicleta">Bicicleta</option>
                                <option value="Camioneta">Camioneta</option>
                            </select>
                        </div>
                        <div class="field">
                            <label for="entrada">Hora de entrada</label>
                            <input id="entrada" name="entrada" type="datetime-local" required>
                        </div>
                    </div>
                </fieldset>

                <div class="form-actions">
                    <button class="btn primary" type="submit">Registrar</button>
                    <button class="btn" type="reset">Limpiar</button>
                </div>
            </form>
        </section>

        <section class="card" aria-labelledby="titulo-listado">
            <div class="list-header">
                <h2 id="titulo-listado">Vehículos Registrados</h2>
                <div class="input-inline">
                    <label for="filtro">Buscar</label>
                    <input id="filtro" type="search" placeholder="Filtrar por placa, nombre, documento...">
                </div>
            </div>
            <div class="table-wrapper" tabindex="0">
                <table id="tablaRegistros">
                    <thead>
                        <tr>
                            <th>Placa</th>
                            <th>Tipo</th>
                            <th>Dueño</th>
                            <th>Documento</th>
                            <th>Contacto</th>
                            <th>Entrada</th>
                            <th>Salida</th>
                            <th>Precio</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- registros dinámicos -->
                    </tbody>
                </table>
            </div>
        </section>
    </main>

    <footer class="app-footer" role="contentinfo">
        <div class="container">
            <p>Tarifa: <strong id="tarifaLabel">$3.000/hora</strong> • SoftParty 2025</p>
        </div>
    </footer>

    <!-- jsPDF CDN -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="assets/js/app.js"></script>
    <script>
        // --- Utilidades para manejar registros en localStorage ---
        function obtenerRegistros() {
            return JSON.parse(localStorage.getItem('vehiculos')) || [];
        }

        function guardarRegistros(registros) {
            localStorage.setItem('vehiculos', JSON.stringify(registros));
        }

        function calcularPrecio(entrada, salida) {
            if (!entrada || !salida) return '';
            const tarifa = 3000;
            const fechaEntrada = new Date(entrada);
            const fechaSalida = new Date(salida);
            let horas = (fechaSalida - fechaEntrada) / (1000 * 60 * 60);
            if (horas < 0) return '';
            horas = Math.ceil(horas) || 1;
            return '$' + (horas * tarifa).toLocaleString();
        }

        // --- Renderizar la tabla de vehículos ---
        function renderizarTabla() {
            const registros = obtenerRegistros();
            const tbody = document.querySelector('#tablaRegistros tbody');
            tbody.innerHTML = '';

            registros.forEach((reg, idx) => {
                const precio = reg.salida ? calcularPrecio(reg.entrada, reg.salida) : '';
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${reg.placa}</td>
                    <td>${reg.tipo}</td>
                    <td>${reg.nombre}</td>
                    <td>${reg.documento}</td>
                    <td>${reg.contacto}</td>
                    <td>${reg.entrada}</td>
                    <td>
                        ${reg.salida ? reg.salida : `<button class="btn btn-salida" data-idx="${idx}">Registrar salida</button>`}
                    </td>
                    <td>${precio}</td>
                    <td>
                        <button class="btn btn-factura" data-idx="${idx}" ${reg.salida ? '' : 'disabled'}>Factura PDF</button>
                    </td>
                `;
                tbody.appendChild(tr);
            });

            // Evento para registrar salida
            document.querySelectorAll('.btn-salida').forEach(btn => {
                btn.addEventListener('click', function() {
                    const idx = this.getAttribute('data-idx');
                    const registros = obtenerRegistros();
                    const ahora = new Date();
                    // Formato compatible con input datetime-local
                    const salida = ahora.toISOString().slice(0,16);
                    registros[idx].salida = salida.replace('T', ' ');
                    guardarRegistros(registros);
                    renderizarTabla();
                });
            });

            // Evento para factura PDF
            document.querySelectorAll('.btn-factura').forEach(btn => {
                btn.addEventListener('click', function() {
                    const idx = this.getAttribute('data-idx');
                    generarFacturaPDF(obtenerRegistros()[idx]);
                });
            });
        }

        // Generar factura PDF
        function generarFacturaPDF(registro) {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();

            doc.setFontSize(20);
            doc.setTextColor(59, 130, 246);
            doc.text('SISPark - Factura de Parqueadero', 14, 18);

            doc.setDrawColor(59, 130, 246);
            doc.line(14, 22, 196, 22);

            doc.setFontSize(12);
            doc.setTextColor(0, 0, 0);

            doc.autoTable({
                startY: 28,
                head: [['Campo', 'Valor']],
                body: [
                    ['Nombre', registro.nombre],
                    ['Documento', registro.documento],
                    ['Contacto', registro.contacto],
                    ['Placa', registro.placa],
                    ['Tipo de vehículo', registro.tipo],
                    ['Hora de entrada', registro.entrada],
                    ['Hora de salida', registro.salida || 'No registrada'],
                    ['Precio final', registro.salida ? calcularPrecio(registro.entrada, registro.salida) : 'Pendiente']
                ],
                theme: 'grid',
                headStyles: { fillColor: [59, 130, 246] },
                styles: { fontSize: 12 }
            });

            let finalY = doc.lastAutoTable.finalY;
            doc.setFontSize(12);
            doc.text(`Tarifa: $3.000/hora`, 14, finalY + 10);
            doc.text('Gracias por usar SISPark', 14, finalY + 20);

            doc.save(`Factura_${registro.placa}.pdf`);
        }

        // --- Registrar nuevo vehículo ---
        document.getElementById('formRegistro').addEventListener('submit', function(e) {
            e.preventDefault();

            const registro = {
                nombre: this.nombre.value.trim(),
                documento: this.documento.value.trim(),
                contacto: this.contacto.value.trim(),
                placa: this.placa.value.trim().toUpperCase(),
                tipo: this.tipo.value,
                entrada: this.entrada.value.replace('T', ' ')
            };

            if (!registro.nombre || !registro.documento || !registro.contacto || !registro.placa || !registro.tipo || !registro.entrada) {
                alert('Por favor, completa todos los campos.');
                return;
            }

            const registros = obtenerRegistros();
            registros.push(registro);
            guardarRegistros(registros);

            this.reset();
            renderizarTabla();
        });

        // --- Inicializar tabla al cargar la página ---
        document.addEventListener('DOMContentLoaded', renderizarTabla);
    </script>

</html>